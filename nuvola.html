<html>
	<head>
    <meta charset='utf-8'>
		<title>Nuvola personale</title>
	</head>
  <style>
table {
	border-collapse: collapse;
}
thead {
background-color: #ccc;
}
div.small-box {
	position: absolute;
	border: 1pt dotted #999;
	text-align: center;
	vertical-align: middle;
	width: 48px;
	height: 48px;
	padding: 4px;
	margin: 2px;
	font-size: 10pt;
	text-decoration: none;
}
div.think {
	position: absolute;
	display: inline-block;
	border: 1pt dotted #999;
	text-align: center;
	vertical-align: middle;
	width: 340px;
	padding: 4px;
	margin: 2px;
	font-size: 10pt;
	border-radius: 5px;
	text-decoration: none;
	background-color: #f79c76;
}
div.answer {
	position: absolute;
	border: 1pt dotted #999;
	text-align: center;
	vertical-align: middle;
	top: 6px;
	left: 380px;
	width: 340px;
	height: 80px;
	padding: 4px;
	margin: 2px;
	font-size: 10pt;
	text-decoration: none;
	background-color: #91f776;
	padding-bottom: 20px;
}
div.answer textarea {
	width: 100%;
	height: 100%;
	background-color: transparent;
}
div.answer button {
}
div.pw-box {
	position: absolute;
	background-color: #fbd554;
	border: 1pt solid #999;
	text-align: center;
	vertical-align: middle;
	width: 96px;
	height: 36px;
	padding: 4px;
	margin: 2px;
	font-size: 10pt;
	text-decoration: none;
}
.rotor {
	display: none;
	position: absolute;
	width: 16px;
	height: 16px;
	top: 50%;
	left:  50%;
	transform: translate(-50%, -50%);
	opacity: 0.8;
	background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH3wUaES0yLeH++QAAAlhJREFUOMtdk81KW1EQx39zcu9NIJEgKC4MLlLQXbPNwo0V3BhcFl20fQLfowsfQRDxBVy4yBMYEPyiXSiYWqtYqFclSEzMPedMF3qv0YHZzOd//jMjqkqq70VEEBHOz8+1VCoxPj4u6hVFMcYAYNJg7z3ee1SfncYYRASAi4sLdnZ2ALDeorw2C9JOaRLAycmJttttHh4eKBaLdDodbm9vaf9q64dqVYYLyDD8brfL9va2xnGcjRVFEVEUoV4J8yFfv32RnMkhL+AzBNZatra21FpLoVCgXq8zMzPD8fExBwcHiAhxfMv132udmpySNyMANJtNtdYyNjbGysqKDBGpj4+PTE9Ps9hYlJzJkbiEMBe+kpgkCVdXVzw9PdFoNADo9/ukvuXlZZaWluT+/l43tzb1z++LjAQD0Ol0vvf7fSqVCiMjI+K9J4oinHPMzs5KpVIRgJ8/fhL/i7m5id9uQVWrzjkGg8Fz1ZdtqCrWWlSVMAwpFAoEQYD3njcIyuXy5zAMqdVqAAwGA5rNpsZxrEEQEATPVJ2eniIiTExMvEUQRRGrq6siIhweHuru7i4iwsLCgqRbOjo60ru7O4IgoFqtyvsREBHW19e11+uRz+cpl8sYY4jjWFutFu2zM4wxzM/PZxeaHVIq+/v72mq1KBaLdLtdVJUkSYiiCGstc5/mqH2siUcxyGsB51x2+xsbG9rr9RgdHc1InZycpF6vUyqVxHqHc458GJEx7ZzL2L68vNS1tTUd/lJVxXuPtZbEO6yzrx88HJB+497eng7bhtXps6Z5/wG+5nt7pPk6KgAAAABJRU5ErkJggg==);
}
.movable {
	position: absolute;
}	
.rotable:hover div.rotor {
	display: block;
}	
.sizer {
	display: none;
	position: absolute;
	width: 16px;
	height: 16px;
	bottom: -4px;
	right: -4px;
	opacity: 0.8;
	background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH3wUaESwc6CzCdwAAAapJREFUOMuNkjuL6mAQht+JS+KlsAnYWG0XsYh2KQQRjo0i2GplYSHir7DQwsJWLASx9i8IluKJ9iIiNlHxiIVCAmZOtXHjbXdgmG9mmIdh3g/MjFdu27Yr9vt9vu8LeGNE5Monkwni8Th/r70F3INisRgikQhUVeWvOjHfgLZtQxBuzHa7za1WC9lsFpZlIRgMQpZl7Pd7jMdj6LpODwAiAhE5ME3TOJ1Ow+PxgIjAzJAkCY1GA7VaDR/3qzIziAiCIKDT6fByucTlcoFpmjidTgiFQpjNZsjlcqjX6/Rw+ev16orfvdlssqIoXC6XHTWcpmEYvFgsmJkxGo34mazFYpGTyaSr5zyOx+MnAK5Wq5xKpZ4ChsPhQ905uWmay0qlAgBIJBJP5czn83RfcwCiKP7x+XyQZdkl5U/20ev1WBRFWJYFSZIgCAJWqxUGgwGv12tkMhmoqkovP9lms2FN01AqlRytD4cD5vM5zuczptMpvdtACIfDpOv63263i0AgAL/fD8Mw4PV6fxwGcFNht9tNFUXhaDT6UoVn7kq22+2/QqHw62Fmxn8pB4mgcwgvogAAAABJRU5ErkJggg==);
}
.sizable:hover div.sizer {
	display: block;
}	
#log {
	width: 600px;
	border: 1px solid darkgreen;
	background-color: cadetblue;
	color: white;
}
	</style>
  <body>
    <h1>Nuvola personale</h1>
    <p>Collezioni di pensieri soltanto per i tuoi occhi.<br />Quei begli occhi socchiusi.</p>
    <div id=mura></div>
    <div id="b1" class="pw-box" style="top: 6px; left: 250px;">
    	<label>Il segreto
    		<input id=segreto type=password size=4 value="" /><button id=vai type=button>Vai</button>
    	</label>
    </div>

    <script type="text/javascript" src="https://cdn.rawgit.com/j-pel/dynamize/master/couching.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/j-pel/dynamize/master/moving.js"></script>
    <!--script type="text/javascript" src="https://cdn.rawgit.com/j-pel/dynamize/master/sizing.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/j-pel/dynamize/master/rotating.js"></script-->
    <script>
(function(){
	
	db = null;

	document.getElementById('segreto').addEventListener('keypress',keypress_handler,false);
	document.getElementById('vai').addEventListener('click',click_handler,false);

	function keypress_handler(event){
		if (event.code === 'Enter') {
			connect(event.target.value);
		}
	}

	function click_handler() {
		connect(document.getElementById('segreto').value);
	}

	function connect(to) {
		db = Couching('https://pelares:'+to+'@pelares.cloudant.com/nuvola');
		refresh();
	}

	function refresh() {
		db.query('index/by_date',{
			descending: true,
			include_docs: true
		}).then(function(info){
			document.getElementById('segreto').value = "";
			display(info.rows);
		}).catch(function(err){
			console.log(err);
		});
	}

	function display(data) {
		var wall = document.getElementById('mura');
		wall.innerHTML = "";
		setTimeout(function() {
			wall.innerHTML = "<center>Tempo scaduto</center>";
		}, 300000);
		var top = 120;
		for (var obj in data) {
			var div = document.createElement('div');
			div.innerHTML = data[obj].doc.text;
			div.classList.add('think');
			div.classList.add('movable');
			if (data[obj].doc.author==="ojos") {
				div.style.left = "380px";
				div.style.backgroundColor = "#91f776";
			}
			top += 40;
			div.style.top = top +"px";
			if (data[obj].doc.style) {
				for (var style in data[obj].doc.style) {
					div.style[style] = data[obj].doc.style[style];
				}
			}
			wall.appendChild(div);
		}
		var div = document.createElement('div');
		var text = document.createElement('textarea');
		text.id = "message";
		div.appendChild(text);
		var button = document.createElement('input');
		button.type = "file";
		button.id = "upload_file";
		button.multiple = true;
		div.appendChild(button);
		var button = document.createElement('button');
		button.type = "button";
		button.id = "send";
		button.innerHTML = "EnvÃ­a";
		div.appendChild(button);
		div.classList.add('answer');
		//div.classList.add('movable');
		wall.appendChild(div);
		document.getElementById('send').addEventListener('click',upload,false);
		moving.init(store_changes);
	}
	var store_changes = function(changes) {
		console.log(changes);
		return 0;
	}

	function upload(event) {
		var text = document.getElementById("message");
		var now = new Date;
		var id = now.toISOString();
		var doc = {_id:id, text:text.value, author:"ojos"};
		db.put(doc).then(function(info){
		  var file = document.getElementById("upload_file");
		  if (file.files.length>0) {
			  upOne(0);
			  function upOne(i) {
			    db.attach(id,file.files[i++]).then(function(data){
			      if(i<file.files.length) upOne(i);
			    });
			  }
		  }
		  refresh();
		}).catch(function(err){
			console.log(err);
		});
	}

})();
    </script>
  </body>
</html>
