<!DOCTYPE html>
<html>
  <head>
    <title>Islas Pelares - Isla Palma</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="icon" href="pelares-16x16.png" type="image/png" />
    <link rel="shortcut icon" href="pelares-16x16.png" type="image/png" />
    <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css">
    <!--link rel="stylesheet" href="../../prj/js/dynamize/css/menu-bar.css"-->
  <style type='text/css'>
  body {
    background-color: #064080;
    font-family: FreeSans, Verdana, sans-serif;
    font-size: 10pt;
  }
  form {
    background-color: #ccc;
    padding: 2px;
  }
  input.new_item {
    width: 48px;
  }
  .CodeMirror {
    border: 1px solid #eee;
    height: 480px;
    width: 100%;
  }
  div.edit-bar {
    width: 520px;
    top: 40px;
    position: fixed;
    right: 10px;
  }
  #menu-bar {
    background-color: #eee;
    position: fixed;
    top: 40px;
    left: 10px;
    width: 180px;
  }
  #ddocs {
    width: 100%;
  }
  #funs {
    width: 100%;
  }
  </style>
  </head>
  <body onload='fix.connect(user.value,password.value,host.value,info.value);'>
    <div id="menu-bar">
      <div id='ddocs'></div>
      <div id='funs'></div>
    </div>
    <form id=form1>
      <center><nobr>
        <label id='message'>Fix:<input size=4 value='jorge' id='user' /></label>
        <label id='message'>:<input size=4 value='' type='password' id='password' /></label>
        <label id='message'>@<input size=8 value='pelares.com' id='host' /></label>
        <label id='message'>/<input size=4 value='servicios' id='info' /></label>
        <button type='button' onClick='fix.connect(user.value,password.value,host.value,info.value);'>Conectar</button>
      </nobr></center>
    </form>
    <br />
    <div class='edit-bar'>
      <textarea id="ed1" class="CodeMirror"></textarea>
    </div>
    <script src="https://cdn.rawgit.com/j-pel/dynamize/master/couching.js"></script>
    <!--script src="../../prj/js/dynamize/couching.js"></script-->
    <script src="http://codemirror.net/lib/codemirror.js"></script>
    <script src="http://codemirror.net/mode/javascript/javascript.js"></script>
    <script>

(function(exports) {

  'use strict';

  var db = null;
  var selected = null;
  var isDirty = false;
  var doc = {};
  var editor1 = CodeMirror.fromTextArea(ed1, {
    lineWrapping: true,
    lineNumbers: true,
    tabSize: 2,
    mode:  "javascript"
  });
  editor1.on('change',function(evt){
    isDirty = true;
  });

  var connect = exports.connect = function(name,password,host,info) {
    doc = {};
    selected = null;
    db = Couching('http://'+name+':'+password+'@'+host+'/'+info);
    var f = document.getElementById('ddocs');
    db.get('_all_docs?startkey="_design/"&endkey="_design0"').then(function(info){
      info.rows.forEach(function(row) {
        var d = createMenuItem(row.id.slice(8));
        d.id = row.id.slice(8);
        f.appendChild(d);
      });
      f.appendChild(createNewItem());
      getDdoc(info.rows[0].id);
      sel.selectedIndex = 0;
    });
  }

  function getDdoc(item) {
    db.get(item).then(function(info){
      doc = info;
      refresh();
    }).catch(function(err){
      console.log("bad",err);
      refresh();
    });
  }

  function select(item) {
    console.log("Selected",item);
    item.style.borderStyle = 'inset';

    if(item.parentNode.id === "ddocs") {
      getDdoc("_design/" + item.id);
    }
    if (selected) {
      (selected[2]) ? doc[selected[0]][selected[1]][selected[2]] = editor1.getValue():
        doc[selected[0]][selected[1]] = editor1.getValue();
        /*
      if (isDirty) db.put(doc).then(function(info){
        doc._rev = info.rev;
        console.log('saved',info);
      }).catch(function(err){
        console.log("bad",err);
      });*/
    }
    switch (item.innerHTML) {
    case 'map':
      selected = [
        item.parentNode.parentNode.parentNode.id,
        item.parentNode.parentNode.id,
        'map'
      ];
      break;
    case 'reduce':
      selected = [
        item.parentNode.parentNode.parentNode.id,
        item.parentNode.parentNode.id,
        'reduce'
      ];
      break;
    default:
      selected = [
        item.parentNode.id,
        item.innerHTML
      ];
    }
    (selected[2]) ? editor1.setValue(doc[selected[0]][selected[1]][selected[2]]):
      editor1.setValue(doc[selected[0]][selected[1]]);
    isDirty = false;
  }

  function refresh() {
    var ddocTypes = {
      views: 'Views',
      lists: 'Lists',
      shows: 'Shows',
      updates: 'Updates',
      filters: 'Filters'
    };
    var funs = document.getElementById('funs');
    funs.innerHTML = "";
    for (var type in ddocTypes) {
      var f = document.createElement('fieldset');
      var l = document.createElement('legend');
      l.innerHTML = ddocTypes[type];
      f.id = type;
      f.appendChild(l);
      if (doc[type]) {
        for (var fun in doc[type]) {
          f.appendChild(createMenuItem(fun));
        }
      }
      f.appendChild(createNewItem());
      funs.appendChild(f);
    };
    var f = document.createElement('fieldset');
    var l = document.createElement('legend');
    l.innerHTML = 'Validation';
    f.id = 'validate';
    f.appendChild(l);
    f.appendChild(createMenuItem('validate_doc_update'));
    funs.appendChild(f);
  }

  function createMenuItem(name) {
    var i = document.createElement('button');
    i.innerHTML = name;
    i.addEventListener('click',function(event){
      select(event.target);
    }, false);
    return i;      
  }

  function createNewItem() {
    var i = document.createElement('input');
    i.placeholder = 'new';
    i.classList.add('new_item');
    i.addEventListener('change',function(event){
      var b = createMenuItem(event.target.value);
      b.id = event.target.value;
      event.target.parentNode.insertBefore(b,event.target);
      event.target.value = "";
    }, false);
    return i;      
  }

})(typeof exports === 'undefined'? this['fix']={}: exports);

    </script>
  </body>
</html>
