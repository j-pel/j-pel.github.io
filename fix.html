<!DOCTYPE html>
<html>
  <head>
    <title>Islas Pelares - Isla Palma</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="icon" href="pelares-16x16.png" type="image/png" />
    <link rel="shortcut icon" href="pelares-16x16.png" type="image/png" />
    <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css">
    <!--link rel="stylesheet" href="../../prj/js/dynamize/css/menu-bar.css"-->
  <style type='text/css'>
  body {
    background-color: #064080;
    font-family: FreeSans, Verdana, sans-serif;
    font-size: 10pt;
  }
  form {
    background-color: #ccc;
    padding: 2px;
  }
  input.new_item {
    width: 48px;
  }
  .CodeMirror {
    border: 1px solid #eee;
    height: 480px;
    width: 100%;
  }
  div.edit-bar {
    width: 520px;
    top: 40px;
    position: fixed;
    right: 10px;
  }
  #menu-bar {
    background-color: #eee;
    position: fixed;
    top: 40px;
    left: 10px;
    width: 180px;
  }
  #ddocs {
    width: 100%;
    padding: 3px 0px 0px 0px;
    background-color: #aaa;
  }
  #funs {
    width: 100%;
  }
  </style>
  </head>
  <body onload='fix.connect(user.value,password.value,host.value,info.value);'>
    <div id="menu-bar">
      <div id='ddocs'></div>
      <div id='funs'></div>
    </div>
    <form id=form1>
      <center><nobr>
        <label id='message'>CouchFix:<input size=4 value='jorge' id='user' /></label>
        <label id='message'>:<input size=4 value='' type='password' id='password' /></label>
        <label id='message'>@<input size=8 value='pelares.com' id='host' /></label>
        <label id='message'>/<input size=4 value='servicios' id='info' /></label>
        <button type='button' onClick='fix.connect(user.value,password.value,host.value,info.value);'>Conectar</button>
      </nobr></center>
    </form>
    <br />
    <div class='edit-bar'>
      <textarea id="ed1" class="CodeMirror"></textarea>
      <textarea id="ed2" class="CodeMirror"></textarea>
    </div>
    <script src="https://cdn.rawgit.com/j-pel/dynamize/master/couching.js"></script>
    <!--script src="../../prj/js/dynamize/couching.js"></script-->
    <script src="http://codemirror.net/lib/codemirror.js"></script>
    <script src="http://codemirror.net/mode/javascript/javascript.js"></script>
    <script>

(function(exports) {

  'use strict';

  var db = null;
  var selected = null;
  var isDirty = false;
  var doc = {};
  var editor1 = CodeMirror.fromTextArea(ed1, {
    lineWrapping: true,
    lineNumbers: true,
    tabSize: 2,
    mode:  "javascript"
  });
  var editor2 = CodeMirror.fromTextArea(ed2, {
    lineWrapping: true,
    lineNumbers: true,
    tabSize: 2,
    mode:  "javascript"
  });
  editor2.display.wrapper.style.display = 'none';

  function changeHandle(evt) {
    isDirty = true;
  }

  var ddocTypes = {
    views: 'Views',
    lists: 'Lists',
    shows: 'Shows',
    updates: 'Updates',
    filters: 'Filters'
  };

  var connect = exports.connect = function(name,password,host,info) {
    selected = null;
    doc = {};
    db = Couching('http://'+name+':'+password+'@'+host+'/'+info);
    var f = document.getElementById('ddocs');
    db.get('_all_docs?startkey="_design/"&endkey="_design0"').then(function(info){
      info.rows.forEach(function(row) {
        var d = createMenuItem(row.id.slice(8));
        d.id = row.id.slice(8);
        f.appendChild(d);
      });
      f.appendChild(createNewItem());
      select(document.getElementById(info.rows[0].id.slice(8)));
    });
  }

  function getDdoc(item) {
    db.get(item).then(function(info){
      doc[item] = info;
      selected = [item,0,0];
      isDirty = false;
      refresh();
    }).catch(function(err){
      console.log("bad",err);
      refresh();
    });
  }

  function select(item) {
    item.style.borderStyle = 'inset';
    if(item.parentNode.id === "ddocs") {
      if (selected) {
        document.getElementById(selected[0].slice(8)).style.borderStyle = 'outset';
        if (isDirty) db.put(doc[selected[0]]).then(function(info){
          doc._rev = info.rev;
          console.log('saved',info);
        }).catch(function(err){
          console.log("bad",err);
        });
      }
      getDdoc("_design/" + item.id);
    } else {
      try {
        document.getElementById(selected[2]).style.borderStyle = 'outset';
        switch (selected[1]) {
        case "views":
          doc[selected[0]][selected[1]][selected[2]]['map'] = editor1.getValue();
          doc[selected[0]][selected[1]][selected[2]]['reduce'] = editor2.getValue();
          break;
        case "validate":
          doc[selected[0]][selected[2]] = editor1.getValue();
          break;
        default:
          doc[selected[0]][selected[1]][selected[2]] = editor1.getValue();
        }
      } catch(err) {

      }
      selected[1] = item.parentNode.id;
      selected[2] = item.id;
      editor1.on('change',function(){});
      editor2.on('change',function(){});
      switch (item.parentNode.id) {
      case "views":
        editor1.setValue(doc[selected[0]][selected[1]][selected[2]]['map']);
        editor2.display.wrapper.style.display = 'block';
        editor1.display.wrapper.style.height = '360px';
        editor2.display.wrapper.style.height = '120px';
        if (doc[selected[0]][selected[1]][selected[2]]['reduce']) {
          editor2.setValue(doc[selected[0]][selected[1]][selected[2]]['reduce']);
        } else {
          editor2.setValue("");
        }
        break;
      case "validate":
        editor1.setValue(doc[selected[0]][selected[2]]);
        editor1.display.wrapper.style.height = '480px';
        editor2.display.wrapper.style.display = 'none';
        break;
      default:
        editor1.setValue(doc[selected[0]][selected[1]][selected[2]]);
        editor1.display.wrapper.style.height = '480px';
        editor2.display.wrapper.style.display = 'none';
      }
      editor1.on('change',changeHandle);
      editor2.on('change',changeHandle);
    }
  }

  function refresh() {
    var funs = document.getElementById('funs');
    funs.innerHTML = "";
    for (var type in ddocTypes) {
      var f = document.createElement('fieldset');
      var l = document.createElement('legend');
      l.innerHTML = ddocTypes[type];
      f.id = type;
      f.appendChild(l);
      if (doc[selected[0]][type]) {
        for (var fun in doc[selected[0]][type]) {
          f.appendChild(createMenuItem(fun));
        }
      }
      f.appendChild(createNewItem());
      funs.appendChild(f);
    };
    var f = document.createElement('fieldset');
    var l = document.createElement('legend');
    l.innerHTML = 'Validation';
    f.id = 'validate';
    f.appendChild(l);
    f.appendChild(createMenuItem('validate_doc_update'));
    funs.appendChild(f);
  }

  function createMenuItem(name) {
    var i = document.createElement('button');
    i.innerHTML = name;
    i.id = name;
    i.addEventListener('click',function(event){
      select(event.target);
    }, false);
    return i;      
  }

  function createNewItem() {
    var i = document.createElement('input');
    i.placeholder = 'new';
    i.classList.add('new_item');
    i.addEventListener('change',function(event){
      var b = createMenuItem(event.target.value);
      b.id = event.target.value;
      event.target.parentNode.insertBefore(b,event.target);
      event.target.value = "";
    }, false);
    return i;      
  }

})(typeof exports === 'undefined'? this['fix']={}: exports);

    </script>
  </body>
</html>
